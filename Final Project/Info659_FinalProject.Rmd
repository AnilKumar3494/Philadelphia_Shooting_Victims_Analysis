---
title: "Philadelphia Shooting Victims Analysis"
author: "Anil Kumar, Shawn Thomas, Nicole Padilla"
output:
  html_document:
    df_print: paged
---
̥
# Introduction
Gun violence is a significant issue in the city of Philadelphia. [There were 771 shooting incidents in the city in 2024 per the Philadelphia Police Department](https://www.phillypolice.com/crime-data/crime-statistics/). The goal of this project is to utilize the data provided by the Philadelphia Police Department via OpenDataPhilly on shooting incidents to build a picture of the fatal shooting incidents occurring in the city. Who is most likely to be the victim of a fatal incident (age, race, sex)? What conditions of an incident make it more likely to be fatal (wound type)? When and where are the most fatal incidents occurring (time of day/year, location)? 

Understanding the trends of fatal gun violence incidents can assist in painting a clearer picture of the problem and point towards potential solutions. Understanding the time and location of the most dangerous shootings provides guidance for police on where to focus their efforts. Understanding who is most at risk of a fatal shooting guides social and health services towards populations that may benefit from interventions to assist shooting victims. 

# Data Overview
The data is collected by the Philadelphia Police Department and provided via OpenDataPhilly. Below, we will load the data and gather the available variables for answering our questions. 

Looking at the available fields we have a rich potential set of data to answer our questions. The age, race, sex and latino fields can provide a profile of the most frequent shooting victims. Wound can inform which types of injuries are most often fatal. Location, time and date can be used to determine when and where fatal incidents occur most often. These fields will be compared to the fatal column in order to determine fatality incidence.

```{r}
# Install necessary packages (run this only once)
# install.packages(c("tidyverse", "sf", "leaflet", "ggplot2", "viridis", "readr", "sp", "leaflet.extras", "readxl", "htmltools", "htmlwidgets", "shiny", "dplyr"))

#install.packages("RColorBrewer")

# Load the packages
library(tidyverse)
library(sf)
library(leaflet)
library(ggplot2)
library(viridis)
library(readr)
library(sp)
library(leaflet.extras)
library(htmltools)
library(htmlwidgets)
library(shiny)
library(dplyr)
library(RColorBrewer)
library(jsonlite)


library(tidyverse)
library(readxl)
```

```{r}
shootings.raw = read_delim(
  "./philly_shootings.csv",
  delim=",",
  show_col_types = FALSE,
) %>% glimpse()
```

# Exploratory Data Analysis

## Handling NAs

First, we look at NAs to see where we may have missing data that needs to be cleaned up. Looking at the summary of NAs a group of 153 NAs shows up across multiple columns including fatal. We will investigate those to clean them up since they will prevent us from accurately summing the fatalities.

```{r}
shootings.raw %>% summarise_all(~ sum(is.na(.)))
```
Based on this, it looks like certain columns, including fatal, are left blank in any incident that involves an officer. In these cases the only fatality data provided is offender deceased.  However, this would leave out any other fatalities that occurred during the incident since not everyone injured in a shooting incident is necessarily an offender.

Critical data for our analysis is missing from all of these officer involved shootings - time, race, age, wound, latino and, most importantly, fatal. There are 40 fatal incidents with an officer involved for which there is incomplete data.

```{r}
shootings.raw %>% filter(if_any(fatal, is.na))
```

```{r}
shootings.raw %>% filter(officer_involved == 'Y')
```
```{r}
shootings.officer = shootings.raw %>% filter(officer_involved == 'Y')

shootings.officer %>% filter(offender_deceased == 'Y')
```

We can make an adjusted table, adding a total_fatality column that includes offender_deceased. It will not be usable for the questions of the profile of the most frequent shooting victims and their wound types, or the time of day of incidents, since that data is missing, but it can be used for the geolocation and date questions. 

This introduces some potential bias into our data because it is possible that we are excluding non-offender fatalities. It is unknown to us if those are excluded or just did not occur. However, it is more complete than not including these 40 fatalities at all.

This gives us a column, total_fatality, with no NAs that can be summed to a total of 3494 fatalities between 2015 and 2025. 

```{r}
shootings.adjusted = shootings.raw

shootings.adjusted$offender_fatal <- ifelse(shootings.raw$offender_deceased == "Y", 1, 0)

shootings.adjusted <- shootings.adjusted %>% 
                      mutate(fatal = replace_na(fatal, 0))

shootings.adjusted$total_fatality <- shootings.adjusted$offender_fatal + shootings.adjusted$fatal

shootings.adjusted

```

```{r}
sum(shootings.adjusted$total_fatality)
```
## Examining Data by Year

Looking at fatality totals by year we can see that partial data is included for 2025. This will obviously be skewed on an annual basis since 2025 is not complete yet. We can see here that fatal shooting incidents rose from 2015 to 2021, peaked in 2021, then fell from 2021-2024.

```{r}
fatal.byyear = aggregate(shootings.adjusted['total_fatality'], by=shootings.adjusted['year'], sum)

fatal.15to24 <- fatal.byyear %>%
  filter(year != 2025)

ggplot(data = fatal.15to24, aes(x = year, y = total_fatality)) +
  ggtitle("Total Fatal Shooting Victims by Year 2015-2024") +
  geom_col() +
  scale_x_continuous(breaks = 2015:2024)
```
## Fatal Shooting Victim Profile

For this analysis we will be only looking at victims of criminal shootings, not officer involved shootings so we will only use the fatal column, not total_fatality.
ṁ
### Age of Victims
First let's get the mean age of fatal shooting victim.
```{r}
fatal.only <- shootings.adjusted %>%
  filter(fatal == 1)

fatal.only <- fatal.only[!is.na(fatal.only$age), ]

mean(fatal.only$age)
```

Now, we will look at the overall distribution of shooting victim age.
```{r}
ggplot(data = shootings.adjusted, aes(x = age, y = fatal)) +
  ggtitle("Age Distribution of Fatal Shooting Victims") +
  geom_col()
```
## Counting shootings to which body parts were most fatal

```{r}
fatal_df <- shootings.raw[shootings.raw$fatal == 1, ]
```


```{r}
injury_counts <- table(fatal_df$wound)
injury_counts
```

```{r}
sorted_injury_counts <- sort(injury_counts,decreasing = TRUE)
print(sorted_injury_counts)
```

## Plotting it

```{r}
barplot(sorted_injury_counts,las = 2,
        col = "steelblue",     # Bar color
        main = "Injury Types in Fatal Shootings",
        ylab = "Number of Fatal Cases",
        cex.names = 0.7)  

```




#### which age groups are mostly affected by fatal shootings

```{r}

fatal_df <- shootings.raw[shootings.raw$fatal==1,]
head(fatal_df)
```




## Sort by age
```{r}

fatal_df$age_group <- cut(fatal_df$age,
                          breaks = seq(0, 100, by = 10),
                          right = FALSE,
                          labels = c("0-9", "10-19", "20-29", "30-39", 
                                     "40-49", "50-59", "60-69", "70-79", 
                                     "80-89", "90-99"))

```


```{r}
age_counts <- table(fatal_df$age_group)
age_counts <- sort(age_counts, decreasing = TRUE)
print(age_counts)
```




## Plotting fatal shooting counts with respect to age
```{r}


barplot(age_counts,
        main = "Fatal Shootings by Age Group",
        xlab = "Age Group",
        ylab = "Number of Fatal Shootings",
        col = "darkred",
        cex.names = 0.7)


```


### Average Age over Time

First, we will calculate the mean age of fatal shooting victim by year. 
```{r}
age_avg <- fatal.only %>%
  group_by(year) %>%
  summarize(average_value = mean(age))

age_avg
```



First, we will calculate the mean age of fatal shooting victim by year. 
```{r}
age_avg <- fatal.only %>%
  group_by(year) %>%
  summarize(average_value = mean(age))

age_avg
```

Then, let's visualize the average age by year for 2015 - 2014. We are excluding 2025 because it is a partial year of data.

```{r}
ggplot(data = age_avg, aes(x = year, y = average_value)) +
  ggtitle("Average Age of Fatal Shooting Victims by Year 2015-2024") +
  geom_col() +
  scale_x_continuous(breaks = 2015:2024)
```



# AK - Geospatial Analysis
## Clean and prepare the data
```{r clean_data}
# View structure
glimpse(shootings.adjusted)
summary(shootings.adjusted)

shootings.spatial  <- shootings.adjusted %>%
  filter(!is.na(lat) & !is.na(lng)) %>%
  rename(latitude = lat, longitude = lng)
```

## Convert to spatial data
```{r spatial_data}
shootings_sf <- st_as_sf(shootings.spatial , coords = c("longitude", "latitude"), crs = 4326)
```

## Plotting Static Map
Visualizes Philadelphia shooting incidents using geospatial coordinates. The scatter plot reveals the geographic distribution, with red dots highlighting significant clustering of events in specific areas of the city.
```{r static_map}
ggplot(data = shootings_sf) +
  geom_sf(alpha = 0.3, color = "red") +
  theme_minimal() +
  labs(title = "Philadelphia Shooting Incidents",
       subtitle = "Based on geospatial coordinates",
       caption = "Source: philly_shootings.csv")
```


## Interactive Map Using Leaflet
This interactive map displays shooting incidents in Philadelphia from 2015 to 2025. Each dot represents a single event and is color-coded by year. With all years selected, the visualization reveals the cumulative geographic distribution and extremely dense concentration of shootings in specific neighborhoods across the city. Futher incidents can be filtered based on year. Clicking a data point reveals a pop-up with specific details for that shooting, including its exact date, location, and fatality/injury information.

```{r leaflet_interactive_map_enhanced, message=FALSE, warning=FALSE}
if (!"total_fatality" %in% names(shootings_sf) || !"year" %in% names(shootings_sf) || !"date_" %in% names(shootings_sf) || !"location" %in% names(shootings_sf) ) {
  stop("shootings_sf is missing one or more required columns: year, date_, location, total_fatality.")
}

if (!"unique_id" %in% names(shootings_sf)) {
  shootings_sf <- shootings_sf %>%
    dplyr::mutate(unique_id = paste0("marker-", dplyr::row_number(), "-", year))
}

# Create unique list of years
years <- if ("year" %in% names(shootings_sf)) sort(unique(shootings_sf$year)) else character(0)

# Create color palette
if (length(years) > 0) {
  if (length(years) <= 8) {
    year_palette_colors <- RColorBrewer::brewer.pal(max(3, length(years)), "Dark2")
    if (length(years) < 3) {
      year_palette_colors <- year_palette_colors[1:length(years)]
    }
  } else {
    year_palette_colors <- grDevices::colorRampPalette(RColorBrewer::brewer.pal(min(length(years), 9), "Dark2"))(length(years))
  }
  year_colors <- leaflet::colorFactor(palette = year_palette_colors, domain = years)
} else {
  year_colors <- NULL
  warning("Year column not found or no unique years in shootings_sf. Map may not display year layers correctly.")
}

# Create base map centered on Philadelphia
center_lon <- -75.1652
center_lat <- 39.9526

m <- leaflet::leaflet(shootings_sf) %>%
  leaflet::setView(lng = center_lon, lat = center_lat, zoom = 11) %>%
  leaflet::addProviderTiles(leaflet::providers$CartoDB.Positron) %>%
  htmlwidgets::onRender("function(el, x) { el.classList.add('safegraph-map'); }")

# Add circle markers by year
if (length(years) > 0 && !is.null(year_colors)) {
  for (yr in years) {
    year_data <- shootings_sf %>% dplyr::filter(year == yr)
    if (nrow(year_data) > 0) {
      m <- m %>% leaflet::addCircleMarkers(
        data = year_data,
        radius = 5,
        color = ~year_colors(year),
        fillOpacity = 0.7,
        stroke = FALSE,
        group = as.character(yr),
        popup = ~paste(
          "<b>Year:</b>", htmltools::htmlEscape(year), "<br>",
          "<b>Date:</b>", htmltools::htmlEscape(date_), "<br>",
          "<b>Location:</b>", htmltools::htmlEscape(location), "<br>",
          "<b>Fatality:</b>", ifelse(total_fatality > 0, "Yes", "No"),
          "<b>Wound:</b>", htmltools::htmlEscape(wound)
        ),
        layerId = ~unique_id
      )
    }
  }
}

# Add layer control
if (length(years) > 0) {
  m <- m %>% leaflet::addLayersControl(
    overlayGroups = as.character(years),
    options = leaflet::layersControlOptions(collapsed = FALSE)
  )
}

## For button
year_groups_json_str <- jsonlite::toJSON(as.character(years)) # Prepare JSON string once

select_toggle_js <- paste0(
  "function(el, x, data) {\n",
  "  setTimeout(function() {\n",
  "    var yearGroups = ", year_groups_json_str, ";\n",
  "    if (!yearGroups || yearGroups.length === 0) { console.warn('No year groups for toggle button.'); return; }\n",
  "    var layersControlContainer = el.querySelector('.leaflet-control-layers-overlays');\n",
  "    if (!layersControlContainer) { console.warn('Layers control container not found for toggle button.'); return; }\n",
  "\n",
  "    var toggleButton = L.DomUtil.create('button', 'leaflet-control-layers-selector safegraph-button');\n",
  "    toggleButton.style.marginBottom = '10px';\n",
  "\n",
  "    function getCurrentAllCheckedState() {\n",
  "      if (yearGroups.length === 0) return false;\n",
  "      for (var i = 0; i < yearGroups.length; i++) {\n",
  "        var groupStr = String(yearGroups[i]);\n",
  "        var checkbox = layersControlContainer.querySelector('input[type=\"checkbox\"][value=\"' + groupStr + '\"]');\n",
  "        if (!checkbox || !checkbox.checked) return false;\n",
  "      }\n",
  "      return true;\n",
  "    }\n",
  "\n",
  "    function updateButtonText() {\n",
  "      if (getCurrentAllCheckedState()) {\n",
  "        toggleButton.innerHTML = 'Deselect All Years';\n",
  "      } else {\n",
  "        toggleButton.innerHTML = 'Select All Years';\n",
  "      }\n",
  "    }\n",
  "\n",
  "    toggleButton.onclick = function() {\n",
  "      var currentlyAllChecked = getCurrentAllCheckedState();\n",
  "      var targetState = !currentlyAllChecked;\n",
  "      yearGroups.forEach(function(group) {\n",
  "        var groupStr = String(group);\n",
  "        var checkbox = layersControlContainer.querySelector('input[type=\"checkbox\"][value=\"' + groupStr + '\"]');\n",
  "        if (checkbox) {\n",
  "          if (checkbox.checked !== targetState) {\n",
  "            checkbox.click();\n",
  "          }\n",
  "        }\n",
  "      });\n",
  "      updateButtonText();\n",
  "    };\n",
  "\n",
  "    layersControlContainer.parentNode.insertBefore(toggleButton, layersControlContainer);\n",
  "    updateButtonText(); /* Set initial button text */\n",
  "  }, 250);\n",
  "}\n"
)

m <- m %>% htmlwidgets::onRender(select_toggle_js)

# Add legend
if (length(years) > 0 && !is.null(year_colors)) {
  m <- m %>% leaflet::addLegend(
    position = "bottomleft",
    pal = year_colors,
    values = shootings_sf$year,
    title = "Shooting Year",
    opacity = 1
  )
}

# CSS Styling using paste0
css_styling_js <- paste0(
  "function(el, x) {\n",
  "  var css = `\n", 
  "    .safegraph-map { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden; }\n",
  "    .safegraph-button { background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; transition: background-color 0.3s ease; font-family: 'Arial', sans-serif; color: #333; display: block; width: 100%; text-align: center; white-space: nowrap; box-sizing: border-box; }\n",
  "    .safegraph-button:hover { background-color: #e0e0e0; }\n",
  "    .leaflet-control-layers-list input[type='checkbox'] { margin-right: 4px; }\n",
  "    .leaflet-popup-content { font-size: 12px; line-height: 1.4; }\n",
  "    .leaflet-popup-content b { font-weight: 600; color: #2c3e50; }\n",
  "    .leaflet-control-layers { background-color: rgba(255,255,255,0.9); border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 6px 10px; font-size: 12px; color: #34495e; }\n",
  "    .leaflet-control-layers-title { font-weight: bold; margin-bottom: 6px; color: #2c3e50; }\n",
  "  `;\n", 
  "  var style = document.createElement('style');\n",
  "  style.type = 'text/css';\n",
  "  style.appendChild(document.createTextNode(css));\n",
  "  document.head.appendChild(style);\n",
  "  if (!el.classList.contains('safegraph-map')) { el.classList.add('safegraph-map'); }\n",
  "}\n"
)

m <- m %>% htmlwidgets::onRender(css_styling_js)

# Display map
m
```

```{r}
# Define map center
center_lon <- -75.1652
center_lat <- 39.9526

# Prepare base data for the map
# This assumes 'shootings_sf' contains 'officer_involved' and 'offender_deceased' from your raw data processing
shootings_sf_for_map <- shootings_sf %>%
  dplyr::mutate(
    incident_color = ifelse(total_fatality > 0, "red", "orange"),
    fatality_label = ifelse(total_fatality > 0, "Fatal", "Non-Fatal")
  )

# Check for necessary columns for filtering new heatmaps
if (!all(c("officer_involved", "offender_deceased", "total_fatality") %in% names(shootings_sf_for_map))) {
  stop("One or more required columns ('officer_involved', 'offender_deceased', 'total_fatality') are missing from shootings_sf_for_map.")
}
if (!"wound" %in% names(shootings_sf_for_map)) {
  warning("The column 'wound' was not found in the data. Wound information will be missing from popups.")
}


# Create filtered datasets for new heatmap layers
officer_involved_fatal_sf <- shootings_sf_for_map %>%
  dplyr::filter(officer_involved == 'Y' & total_fatality > 0)

officer_involved_non_fatal_sf <- shootings_sf_for_map %>%
  dplyr::filter(officer_involved == 'Y' & total_fatality == 0)

offender_deceased_sf <- shootings_sf_for_map %>%
  dplyr::filter(offender_deceased == 'Y') 

all_officer_involved_sf <- shootings_sf_for_map %>%
  dplyr::filter(officer_involved == 'Y')
  
# Create the Leaflet map
map_enhanced_heatmaps <- leaflet::leaflet(data = shootings_sf_for_map) %>% # Base data
  leaflet::setView(lng = center_lon, lat = center_lat, zoom = 11) %>%
  leaflet::addProviderTiles(leaflet::providers$CartoDB.Positron, group = "Base Map") %>%
  
  # Clustered Markers (as before)
  leaflet::addAwesomeMarkers(
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    icon = ~leaflet::awesomeIcons(
      icon = 'info-circle', 
      library = 'glyphicon', 
      markerColor = incident_color, 
      iconColor = 'white'
    ),
    popup = ~paste(
      "<b>Year:</b>", htmltools::htmlEscape(year), "<br>",
      "<b>Date:</b>", htmltools::htmlEscape(date_), "<br>",
      "<b>Location:</b>", htmltools::htmlEscape(location), "<br>",
      "<b>Fatality:</b>", ifelse(total_fatality > 0, "Yes", "No"), "<br>",
      "<b>Wound:</b>", if ("wound" %in% names(.)) htmltools::htmlEscape(wound) else "N/A"
    ),
    clusterOptions = leaflet::markerClusterOptions(),
    group = "Shooting Incidents (Clusters)"
  ) %>%
  
  # Heatmap
  leaflet.extras::addHeatmap(
    # Data from leaflet() call: shootings_sf_for_map
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15,
    group = "Heatmap (All Incidents)"
  ) %>%

  # Heatmap for All Fatal Incidents
  leaflet.extras::addHeatmap(
    data = dplyr::filter(shootings_sf_for_map, total_fatality > 0), 
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15,
    group = "Heatmap (All Fatal Incidents)" 
  ) %>%
  
  # Heatmap for Officer Involved & Fatal Incidents
  leaflet.extras::addHeatmap(
    data = officer_involved_fatal_sf,
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15,
    group = "Heatmap (Officer Involved & Fatal)"
  ) %>%
  
  leaflet.extras::addHeatmap(
    data = officer_involved_non_fatal_sf,
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15, 
    group = "Heatmap (Officer Involved & Non-Fatal)"
  ) %>%
  
  # Heatmap for Offender Deceased Incidents
  leaflet.extras::addHeatmap(
    data = offender_deceased_sf,
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15,
    group = "Heatmap (Offender Deceased)"
  ) %>%

  # Heatmap for All Officer Involved Incidents
  leaflet.extras::addHeatmap(
    data = all_officer_involved_sf,
    lng = ~sf::st_coordinates(geometry)[,1], 
    lat = ~sf::st_coordinates(geometry)[,2],
    blur = 20, max = 0.05, radius = 15,
    group = "Heatmap (All Officer Involved)"
  ) %>%
  
  # Legend for Clustered Markers
  leaflet::addLegend(
    position = "bottomright", 
    colors = c("red", "orange"),
    labels = c("Fatal Incident", "Non-Fatal Incident"),
    title = "Incident Type (Markers)",
    opacity = 1,
    group = "Shooting Incidents (Clusters)" 
  ) %>%
  
  # Layers Control to switch between layers
  leaflet::addLayersControl(
    baseGroups = "Base Map",
    overlayGroups = c(
      "Shooting Incidents (Clusters)", 
      "Heatmap (All Incidents)", 
      "Heatmap (All Fatal Incidents)",
      "Heatmap (All Officer Involved)",
      "Heatmap (Officer Involved & Fatal)",
      "Heatmap (Officer Involved & Non-Fatal)", 
      "Heatmap (Offender Deceased)"
    ),
    options = leaflet::layersControlOptions(collapsed = FALSE) 
  ) %>%
  # Hide all heatmap layers by default so clusters are visible first
  leaflet::hideGroup(c(
      "Heatmap (All Incidents)", 
      "Heatmap (All Fatal Incidents)",
      "Heatmap (All Officer Involved)",
      "Heatmap (Officer Involved & Fatal)",
      "Heatmap (Officer Involved & Non-Fatal)",
      "Heatmap (Offender Deceased)"
  ))

# Display the map
map_enhanced_heatmaps
```

